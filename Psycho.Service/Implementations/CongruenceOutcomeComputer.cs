using Psycho.Common.Domain.UserData.Guts;
using Psycho.Common.Repository;
using Psycho.Service.Interfaces;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Psycho.Common.Domain;
using System.Text.RegularExpressions;
using Serilog;

namespace Psycho.Service.Implementations
{
    class CongruenceOutcomeComputer
    {
        private IRespondentsRepository _respondentsRepository;
        private IQuestionnaireRepository _questionnaireRepository;
        private ILogger _log;
        private readonly double[,] _adjuscentMatrix = new double[,]
            {
                {0.8,0.8,0.5,0.5,0.8,0.5,0.5,0.8,0.5,0.8,0.8,0.3,0.5,0.8,0.5},
                {0.8,0.8,0.5,0.5,0.8,0.8,0.1,0.5,0.8,0.8,0.8,0.8,0.8,0.5,0.5},
                {0.5,0.5,0.5,0.3,0.8,0.5,0.3,0.5,0.3,0.8,0.8,0.5,0.5,0.8,0.5},
                {0.5,0.5,0.3,0.1,0.3,0.1,0.5,0.5,0.3,0.8,0.5,0.3,0.5,0.5,0.5},
                {0.8,0.8,0.8,0.3,0.8,0.5,0.8,0.8,0.5,0.8,0.8,0.8,0.8,0.5,0.5},
                {0.5,0.8,0.5,0.1,0.5,0.8,0.8,0.5,0.1,0.8,0.5,0.5,0.5,0.3,0.5},
                {0.5,0.1,0.3,0.5,0.8,0.8,0.8,0.3,0.1,0.5,0.3,0.3,0.5,0.1,0.5},
                {0.8,0.5,0.5,0.5,0.8,0.5,0.3,0.8,0.5,0.8,0.5,0.5,0.8,0.3,0.5},
                {0.5,0.8,0.3,0.3,0.5,0.1,0.1,0.5,0.8,0.8,0.8,0.3,0.5,0.5,0.3},
                {0.8,0.8,0.8,0.8,0.8,0.8,0.5,0.8,0.8,0.8,0.5,0.5,0.8,0.8,0.8},
                {0.8,0.8,0.8,0.5,0.8,0.5,0.3,0.5,0.8,0.5,0.8,0.3,0.8,0.8,0.8},
                {0.3,0.8,0.5,0.3,0.8,0.5,0.3,0.5,0.3,0.5,0.3,0.3,0.3,0.5,0.5},
                {0.5,0.8,0.5,0.5,0.8,0.5,0.5,0.8,0.5,0.8,0.8,0.3,0.8,0.5,0.1},
                {0.8,0.5,0.8,0.5,0.5,0.3,0.1,0.3,0.5,0.8,0.8,0.5,0.5,0.8,0.5},
                {0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.3,0.8,0.8,0.5,0.1,0.5,0.8}
            };
        private readonly string[,] _adjuscentTextes = new string[,]
            {
                {"В вашем мире царит стабильность, уют и спокойствие. И ваш друг полностью разделяет эти ценности. Если вы ищете верного спутника - то обратились по адресу.", "Ваш друг общительнее вас, но также стремится к уюту и спокойствию в жизни. Вы отлично поладите, а заодно легко научитесь выстраивать отношения с людьми.", "Вы очень хорошо дополняете друг друга: ваш друг любит веселье и общение, а вам по душе стабильность и уют. При первой встрече вам может показаться, что вы из разных миров. Но узнайте друг друга получше - и поймете, что вам есть, чему поучиться у другого", "Он даст вам необходимое пространство, но будет требовать того же от вас.", "Он готов давать вам личное пространство, когда потребуется, но всегда будет рядом, чтоб помочь и поддержать.", "Это тот человек, с которым можно просто помолчать, глядя на закат, и знать, что он никуда не уйдет.", "Он очень хаотичен, поэтому только у вас хватит терпения помочь ему организовать свое пространство.", "Он будет доволен вашим спокойствием и надежностью. А если вы оба заскучаете, сможет организовать интересный досуг.", "Ему понравится ваше спокойствие: он уверен, что вы не выкините неприятных сюрпризов. Но только не давайте ему совсем заскучать. Говорите, гуляйте.", "Все хорошо и комфортно - он спокоен, его почти нереально вывести из себя. Никаких пугающих действий он совершать не должен.", "Вас могут пугать перемены в его настроении, но не волнуйтесь - он очень переживает о мнении своего собеседника, поэтому постарается не доставлять вам дискомфорта.", "Вас могут пугать его быстрые перемены настроения. Помните, что они направлены во вне, а не на вас. А если вас что-то обижает - скажите об этом прямо.", "Вы не очень активны в плане развлечений, а вашему другу это и не надо. Главное не замыкайтесь друг на друге, исследуйте новое, и тогда ваши отношения продлятся долго.", "Ваш друг очень любопытный. Расскажите ему о чем-то, чего он не знает. Покажите чтонибудь интересное. Для этого даже не обязательно выходить из дома.", "Ваш друг сможет открыть для вас неизвестные ранее места и способы интересно провести время. Не бойтесь - доверьтесь ем!"},
                {"Вы оба цените спокойствие и уют, хотя вы немного активнее вашего друга. Если выбираетесь общаться с компаниями - не бросайте его одного, помогите наладить общение. В лице вашего друга вы найдете самого верного спутника, только не бросайте его в трудной ситуации.", "Вы оба общительны и независимы. Это может вызывать трудности в общении в виду нежелания каждого из вас принимать ответственность за другого.", "Ваш друг может показаться вам чересчур шумным и активным. Вы более склонны к самостоятельности, а он - к лидерству. Поэтому приготовьтесь отстаивать свое пространство.", "Вы можете быть очень близки, но каждый из вас будет иметь пространство, в которое не будет допущен другой.", "Он поддержит все ваши начинания, а когда вам потребуется личное пространство - проявит уважение.", "С этим человеком вы сможете воплотить самые смелые идеи или просто помолчать, глядя на закат.", "У вас хватит терпения организовать хаос вокруг него. А еще вам не найти лучшего спутника для развлечений!", "Вам будет интересно вместе - в жизни всегда будет доля хаоса и веселья.", "Он будет рад, что вы активны, но не настолько, чтобы нарушить репутацию или сбить его с толку.", "Этот человек - спокойствие и позитив. Вам будет хорошо и комфортно общаться.", "У него могут быть резкие перемены в настроении. Но не переживайте, они довольно редки, и он старайется их контролровать.", "Не напрягайтесь при его переменах настроения - они направлены во вне, а не на вас. Если вас это задевает - просто скажите.", "Вашему другу не надо много разнообразия в развлечения. Чтоб вам не ствло скучно, вытаскивайте его на разные мероприятия время от времени. Может, привьете ему хороший вкус.", "Чтобы поладить, вам придется проявлять инициативу и вытаскивать его на разные мероприятия. Иначе отношения могут просто заглохнуть.", "Будьте активее, доверяйте своему другу - и он сможет открыть для вас новые интересные места и хобби."},
                {"Вы очень хорошо дополняете друг друга: вы любите веселье и общение, а вашему другу по душе стабильность и уют. При первой встрече вам может показаться, что вы из разных миров. Но узнайте друг друга получше - и поймете, что вам есть, чему поучиться у другого", "Вы очень активны и общительны, а также склонны к лидерству. Это может утомлять вашего друга, который ищет независимость и спокойствие. Будьте с ним аккуратнее - и найдете в его лице верного спутника.", "Вы оба общительны и амбициозны. Всегда найдете, как развлечься и чем заняться. Только помните, что вы еще и два лидера. Будьте готовы научиться иногда уступать первенство.", "Скорее всего, всегда будут сферы его жизни, в которые вы не будете допущены.", "Он с радостью поддержит ваши идеи и начинания, но иногда ему будет требоваться личное пространство.", "Скорее всего, ваш друг с радостью присоединится к любой вашей задумке.", "Он не парится о репутации, поэтому с ним вы можете воплотить в жизнь самые смелые идеи.", "Он будет рад вашей активности в его жизни, но желательно, чтобы она не выходила за рамки разумного.", "Он будет рад вашей активности, но до тех пор, пока она вписывается в его личные 'нормы'.", "Этот человек - спокойствие и позитив. Хватайте его - и в путь - за приключениями.", "Вас могут удивлять перемены в его настроении, но не волнуйтесь - они случаются довольно редко и никак не мешают общению.", "Вас могут удивлять быстрые перемены его настроения, но если научитесь не принимать их на свой счет, хорошо проведете время.", "Ваш друг не очень активен в своих увлечениях, поэтому вам придется проявить инициативу.", "Вы можете очень весело провести время, но инициативу вам придется взять в свои руки.", "С вашей активностью и его любопытством вы найдете такие приключения, что вспоминать будут все и очень долго!"},
                {"Своим тихим очарованием он растопит лед в вашем сердце.", "С ним вам будет хорошо и дома, и на мероприятиях. Да, даже такому одинокому волку, как вы.", "Вы, конечно, самостоятельны, но даже вам будет сложно устоять перед активностью вашего друга.", "Вы оба сильны и независимы. Явно способны найти свое место под солнцем. Казалось бы, идеальный тандем. Но чтобы сохранить такие отношения, вам обоим придется начать отдавать тепло и думать о другом. Если даже у одного из вас не получится это делать, отношения без взаимности могут принести печаль.", "Вы любите независимость и возможность самостоятельно распоряжаться своей жизнью. Ваш друг очень похож на вас, но при этом он гораздо чувствительнее. Помните, что если вы не будете дарить друг другу тепло, отношения могут не продлиться долго из-за разочарованности.", "Вам может понравиться общаться с этим человеком, ведь он отзывчив, добр и всегда готов помочь. Но помните, что его доверием нельзя злоупротреблять. Вам нужно давать что-то взамен, чтобы не погубить своего друга.", "У вас сложится крепкая дружба, но однажды вам может надоесть вытаскивать его из переделок.", "Этот человек - отличный товарищ. Он не будет навязывать вам свою философию и не ввяжет в сомнительные авантюры. Вы просто хорошо проведете время.", "Основная проблема - педантичность друга и ваша независимость. Он может начать требовать от вас вещи, которые вы из принципа не захотите делать.", "Он не будет постоянно выдавать вам капризы и претензии, но вам все равно стоит провилять свою заботу о нем", "Иногда он может проявлять сильные эмоции и капризы. Вам стоит определить время, в которое его нужно будет оставить в покое.", "Если он будет чересчур эмоциональным, дайте ему время остынуть.", "Вы очень самоятоятельны. Вам может быть скучновато с таким стабильным человеком.", "Вам будет хорошо с этим человеком: он достаточно стабилен, чтобы давать вам личное пространство, да и поразвлекаться умеет.", "Вдвоем вы сможете очень хорошо развлечься. А если вам что-то не понравится - вашего характера хватит, чтобы отойти в сторону."},
                {"Он привлечет вас своим спокойствием и добротой.", "Он растопит лед в вашем сердце и уведет в мир чудес и радости.", "Не сомневайтесь - присоединяйтесь к его неуемной энергии, и увидите много интересного!", "Вас может привлекать сила и независиомсть этого человека, но помните, что в первую очередь он думает о себе и своих желаниях. Вам придется смириться с этим, если хотите продолжать отношения. Но стоят ли они того без взаимности?", "Вы оба способны позаботиться о себе, но также проявлять искренюю любовь и заботу о близких. Сдружившись, вы обнаружите себя в стабильных отношениях, где почувствуете взаимную поддержку, и ощущения, как за каменной стеной.", "Вам может понравиться общаться с этим человеком, ведь он отзывчив, доверчив и всегда готов помочь. Вам есть, чему поучиться друг у друга: вы научитесь его искренней доброте, а он - способности защититься от других и выстроить свое пространство.", "Вашей выдержки очно хватит на то, чтобы остановить своего импульсивного друга от безрассудных действий.", "Этот человек даст вам необходимую свободу действий, но будет рядом, когда это надо.", "Остерегайтесь чрезмерных требований со стороны своего друга. Он любит четкие порядки и может начать склонять вас к ним. Не ведите борьбу, но и не растворяйтесь в них. Отстаивайте свои привычки, спокойно объясняя свою позицию.", "Даже если он не просит о чем-то напряму, проявите свою заботу.", "Иногда он может проявлять сильные эмоции и капризы. Если вас это заденет - спокойно скажите ему об этом.", "Иногда вас могут ранить его эмоции и капризы. Не молчите - выскажите свои чувства, защитите себя.", "Этот человек даст вам ощущение стабильности. Но не стоит ждать от него развлечений.", "Вы самодостаточны, и сможете развлечься самостоятельно, если ему захочется побыть дома.", "Вы здорово проведете время, и эти вещи явно никогда не забудутся. Только следите, чтобы вас не втянули в неприятности."},
                {"С ним у вас будет тепло и уют.", "Уверенный и неутомимый - вот друг, который вам нужен.", "Вас может приклекать неутомимость вашего друга. Он покажет вам много интересного.", "Вас может привлекать сила и независиомсть этого человека, но помните, что у него есть склонность злоупотреблять вашей добротой и отзывчивостью, ничего не давая взамен. Если заметите такие эгоистические нотки, вам лучше объяснить свои чувства или прекратить такие отношения, ведь без взаимностибудет лишь печаль.", "Ваш друг может позаботиться о себе, но в то же время он проявляет искреннюю заботу и тепло по отношению к тем, кого любит. Понадобится какое-то время, чтобы растопить этот лед, но в ответ вы получите верного друга и партнера.", "Вы наверняка найдете много общих тем для разговора и способов интересно провести время, если обратите внимание на особенность ваших характеров: обы оба чуткие, добрые и отзывчивые люди, готовые всегда поддержать и прийти на помощь. Таким друзьям остается только позавидовать.", "Ваша преданность другу может помешать увидеть его неорганизованность и безответственность. Постарайтесь не ввязываться с ним в сомнительные авантюры, и все будет хорошо.", "Вы можете доверять этому человеку. Он хорошо рассчитывает события и быстро действует в трудной ситуации.", "Будьте бдительны: ваш друг живет по четкому распорядку и может требовать того же от других. Не факт, что вы сможете отстоять свои личные границы и не быть поглощенным этим человеком", "Он не будет внезапно срываться на вас. Все хорошо и спокойно.", "Иногда он может проявлять капризы и эмоции. Если вас это заденет - обязательно защитите себя и скажите ему об этом.", "Иногда вас могут ранить его эмоции и капризы. Если это случится - не молчите. Скажите ему прямо о своих чувствах, но не давайте ввязывать вас в ссору.", "Вы можете легко привязаться к нему, и немудрено: он являет собой стабильность. Только не ждите от него особых приключений.", "Это приятный человек: с ним вы весело проведете время, но он не даст вам влипнуть в неприятности.", "Нет сомнения, что вам будет интересно отправиться в приключения с этим человеком. Но следите, чтоб он не втянул вас в неприятности."},
                {"Что бы вы ни сделали, он будет рядом. Поддержит. Но не забывайте показывать ему свою заботу.", "Его наверняка порадует ваша беспечность. С таким никогда не соскучишься.", "Огонь вашей дружбы будет гореть долго. Там эмоции, страсть, сила.", "Про дружбу сказать сложно, но с вашей силой и его хладнокровием вы точно сможете захватить мир.", "Ему с вами будет интересно и весело. Но главное, что он сможет не дать вам влипнуть в неприятности или сам о себе позаботиться какое-то время.", "Ему будет весело и интересно с таким человеком как вы. Только не втяните его в неприятности, ему будет сложно отказать вам.", "Вы оба хаотичны и импульсивны. При наличии взаимного интереса вы наверняка натворите таких приключений, что на всю жизнь хватит! Не забывайте прислушиваться друг к другу, ведь иногда ваши стремления могут звать вас в противоположных направлениях.", "У вас отличный друг, который может научить вас организовывать свою жизнь так, чтобы не вливать в разные переделки. Он очень похож на вас - также любит хаос и нестабильность, но при этом понимает, где нужно построить четкий план действий. В этих отношениях вам придется поучиться у вас организованности, а ему - умению пустить все на самотек.", "Вы импульсивны и хаотичны, а ваш друг очень предусмотрителен и не живет без четкого плана. С одной стороны, ваши привычки неплохо взаимодополняются. С другой, вы можете изрядно раздражать друг друга, если оба не попытаетесь сглаживать их и идти навстречу.", "Он сможет направить вашу беспечность внужное русло. Или поддержать веселую авантюру.", "Искры будут лететь. Но если вы будете прислушиваться друг к другу, это будут искры страсти.", "Ох, ну и наломаете же вы дров! Старайтесь прислушиваться друг к другу и иногда уступать.", "Он точно сможет терпеть перемены в вашем настроении. Но подумайте, не будет ли вам скучно с 'домашним' человеком", "Вам будет интересно вдвоем. Он постоянно интересуется новым, и покажет много неожиданных вещей.", "Вша импульсивность и его любопытство явно натворят дел!"},
                {"Он создает уют и спокойствие. Это именно то, что вам нужно после тяжелого дня.", "Сделайте шаг навстречу друг другу - и вы точно не пожалеете.", "Вам понравится ваш безбашенный друг. С кем еще вы сможете натворить таких дел!", "Про дружбу сказать сложно, но с вашей рассудительностью и его хладнокровием вы точно сможете захватить мир.", "С вами ему будет хорошо и весело. Он будет искренне рад вашей заботе. В случае нужды сможет позаботиться и о себе, и о вас двоих.", "Вы сможете окружить его заботой и стать для него каменной стеной. Не подведите его преданность.", "Сейчас вы встретились с человеком, который представляет собой сплошной хаос и импульсивность. При наличии взаимного интереса вы наверняка натворите таких приключений, что на всю жизнь хватит! Но в этих отношениях ему придется поучиться у вас организованности, а вам - умению пустить все на самотек.", "Вы нашли идеального человека, который, как и вы, умеет расслабляться в нужное время или, напротив, предусматривать все возможности и планы. Вам точно не будет скучно друг с другом во время развлечений. И в работе вы также найдете верного спутника, который поможет спланировать время и события.", "Вы знаете, где можно расслабленно плыть по течению, а где нужно собраться и построить четкий план. Научите этому вашего друга, который без стратегий жить не может. Удивите его интересным сюрпризом. Бедняга, наверное, давно не развлекался и не был в нормальном отпуске.", "Даже если вас понесет в авантюры, он сможет вас вразумить. А если это весело - с радостью поддержит.", "Не давите друг друга эмоциями. Прислушивайтесь, разговаривайте. Тогда не будет ничего невыполнимого.", "Что бы ни случилось - старайтесь прислушиваться друг к другу и не ввязываться в ссору. Вы очень эмоциональны, но у вас получится!", "С ним вам будет спокойно. Он ничего не делает внезапно и импульсивно.", "Вам будет интересно вдвоем. У него много интересов, и вам будет любопытно попробовать что-нибудь новенькое.", "С ним вы узнаете приключения. Но не сильно. Вы же рассудительный человек и не полезете в авантюры?"},
                {"Тихий уютный дом, гармония и спокойствие.", "Вы дадите ему ощущение уверенности и стабильности. Он вам - уют и энергию.", "Вы дадите ему ощущение уверенности и стабильности. Он вам - активность и много энергии.", "Про дружбу сказать сложно, но с вашей предусмотрительностью и его хладнокровием вы точно сможете захватить мир.", "Он будет искренне рад вашей заботе и помощи. Но что главное, в случае нужды сможет и сам о себе и вас позаботиться.", "Он покажет вам всю свою преданность и будет благодарен за вашу заботу. Главное, не дайте потеряться его собственной личности во всей этой заботе.", "Сейчас вы встретились с человеком, который представляет собой сплошной хаос и импульсивность. С одной стороны, ваши привычки неплохо взаимодополняются. С другой, вы можете изрядно раздражать друг друга, если оба не попытаетесь сглаживать их и идти навстречу.", "У вас отличный друг, который может научить вас расслабляться и плыть по течению время от времени. Он очень похож на вас - также строит планы и думает о будущем, но он также умеет неплохо жить в хаосе и постоянно меняющихся условиях. Вам очень не хватает таких способностей. Наблюдайте за ним внимательно.", "Вы знаете, чего хотите и как этого достичь. Умеете распределить свое время и ресурсы. Ваш друг очень поход на вас. Скорее объединяйтесь, и вместе наверняка исполните все свои планы по захвату мира!", "Иногда он будет проявлять беспечность. Помогите ему организовать пространство.", "Иногда он будет чересчур эмоциональным, иногда - беспечным. Помогите ему организовать пространство, и даже не заметите проблем.", "Вас может раздражать неопределенность его характера. Помните, что он не может контролировать это. Постарайтесь поговорить спокойно, не давайте друг другу претензий.", "Вам будет спокойно рядом с ним: он стабилен, репутацию не портит, сюрпризов не выкидывает", "Вам будет интересно вдвоем. Он постоянно интересуется новым, и вам всегда будет, о чем поговорить.", "Иногда вы можете чувствовать себя некомфортно, когда его любопытство потащит вас в весьма сомнительные места и авантюры."},
                {"Вы с вашим другом на одной волне - полны невозмутимости. Вас обоих почти невозможно вывести из себя. Хорошее начало!", "Вас обоих почти невозможно вывести из себя. В любом месте и компании вы найдете что-то интересное. Пообщайтесь поближе и наверняка найдете верного друга.", "Ваш друг очень открыт общению, а ваша уверенность в себе позволит положить отличный старт отношениям.", "Ваши отношения будут успешнее, если вы будете легко к ним относиться. Ваш друг - не командный игрок. Просто примите это.", "Используйте свой позитив и энергию, чтобы показать вашему другу, что вы его цените. Сдружившись, с ним вы почувствуте себя в безопасности.", "У вас обоих очень приятный хараткр - пользуйтесь добром и позитивом - и все будет хорошо!", "Ваш друг может напрягать вас своей хаотичностью и неорганизованностью. Постарайтесь принять эту черту, а в случае раздражения спокойно объяснить свою позицию.", "Вы с другом умеете сохранять равновесие между интуитивными поступками и четким планированием будущего. Это Чудесные навыки, которые вам очень помогут в дальнейшем.", "Не пускайте дела на самотек, ваш друг предпочитает планировать их заранее.", "Вы и ваш друг обладаете устойчивыми эмоциями и не склонны к резким перепадам настроения. Это обеспечивает вам комфортное общение и отсутствие пустых ссор.", "Вы не склонны к резким перепадам настроения, а ваш друг, хотя и имеет сильные эмоции, способен контролировать их. Это обеспечивает вам комфортное общение и отсутствие глупых ссор.", "Эмоциональность вашего друга может вызывать у вас непонимание или желание уйти от лишней суеты. Помните, что его эмоции, особенно негативные, направлены во вне, и не имеют к вам отношения. Если будете относиться спокойно к его перепадам настроения, вас ждет успех в общении", "Ваш позитивный настрой может натолкнуться на стену нежелания что-либо делать. Но если вы расшевелите его - обретете верного друга.", "Ваш позитив поможет ему выйти из зоны комфорта, и вы наверняка здорово проведете время.", "С вашим позитивом и его любопытством вы легко создадите основу для крепкой дружбы."},
                {"Вы с вашим другом на одной волне - имеете глубокие эмоции и не стремитесь к шуму мира сего. Это хорошее начало.", "Вы оба разносторонние личности: можете быть и в шуме вечеринки, и наслаждаться тишиной и одиночеством. Можете искрить эмоциями и пребывать в стабильном спокойствии. Вы можете найти огромное количество совместных занятий, которые оба оцените.", "Ваш друг очень открыт общению, а ваше понимание и чувственность позволит положить отличный старт отношениям.", "Вам не стоит искать у него эмоциональной поддержки - он вряд ли захочет вам ее оказать.", "У вас почти нет риска поссориться по почве несовпадения характеров. Слушайте друг друга, идите иногда навстречу - и наверняка все будет хорошо.", "Не направляйте на него негативных эмоций, и он проявит к вам всю свою доброту.", "Ваш друг может напрягать вас своей хаотичностью и неорганизованностью. В какой-то момент вы можете начать сильно раздражаться на него. В этих случаях постарайтесь показать ему, что ваши эмоции не направлены лично на него, и спокойно объясните, что бы вы хотели, чтобы он сделал.", "Иногда вы оба склонны к взрывам эмоций и безумным поступкам. Это может не только подарить острые ощущения, но и привести к крупным ссорам.", "Старайтесь не поддаваться сильным эмоциям, а также не пускайте дела на самотек, ваш друг предпочитает планировать все заранее.", "Ваш друг не склонен к резким перепадам настроения, а вы, хотя и имеете сильные эмоции, способны контролировать их. Это обеспечивает вам комфортное общение и отсутствие глупых ссор.", "Вы оба имеете сильные эмоции, хотя способны хорошо контролировать их. Это обеспечивает вам комфортное общение и отсутствие глупых ссор.", "Ваш друг очень эмоционален, что может вызывать трудности при общении. Постарайтесь не принимать на свой счет его резкие перепады настроения, в противном случае, есть риск возникновения ссор.", "Будьте на позитиве, не рассказывайте о плохом и постарайтесь вытащить его из зоны комфорта - и будет успех.", "Будьте на позитиве, не рассказывайте о плохом и постарайтесь вытащить его из зоны комфорта - и будет успех.", "Ваше хорошее настроение - залог хорошего досуга. Сохраняйте позитив - и все будет хорошо!"},
                {"Ваша эмоциональность прекрасно компенсируется вдумчивостью и спокойствием вашего друга. Поняв особенности друг друга, вы точно будете наслаждаться такой компанией.", "Ваш друг склонен погружаться в свои мысли, поэтому ваша эмоциональность может утомлять его. Особенно это касается негативного настроения, которое он может принять на свой счет. Вам стоит вести себя аккуратнее в общении с ним.", "Открытость общению вашего друга и ваша эмоциональность могут принести плоды в виде интересного и веселого совместного достуга. Однако в более долгосрочной перспективе вам нужно будет научиться уступать друг другу: вы часто бываете требовательны, а ваш друг любит лидировать, что может иногда вызывать конфликты.", "У вас есть риск поссориться, поскольку вы склонны к сильным эмоциям, а ваш друг не пойдет вам на встречу, чтобы выслушать или помочь.", "Ваш друг способен оказать поддержку, но все же избегайте частых проявлений негативных эмоций.", "У вас есть риск спугнуть его своей эмоциональностью, которую он примет на свой счет.", "Гремучая смесь: хаотичное поведение друга и ваш взрывной характер могут многое натворить. Будьте осторожнее и старайтесь пореже ссориться.", "Ваш друг может показаться вам чересчур рассудительным и педантичным. Старайтесь не высказывать ему негативных эмоций, а спокойно направьте общение в нужное русло", "Рассудительность и педантичность вашего друга может помешать вашему общению. Будьте осторожнее в выражении своих эмоций.", "Вы обладаете сильными эмоциями. Ваш друг, напротив, редко испытывает перемены настроения. Вы хорошо дополняете друг друга и, скорее всего, не будете испытывать проблем в общении. Главное, не напуайте его эмоциональностью.", "Ваша эмоциональность может вызывать непонимание у вашего друга, который более холоден, чем вы. Для успешной беседы постарайтесь контролировать свое настроение или, в случае негативных эмоций, не направлять их на него", "Вы и ваш друг очень эмоциональны, часто испытываете перемены настроения. Вам может понравиться проводить время друг с другом, делиться энергией, которой у вас двоих предостаточно. Главное, помните, что ваш друг также обидчив. Постарайтесь не задеть его чувств и попросите уважать ваши.", "Постарайтесь не рассказывать вашему другу о плохом настроении или делайте это в форме пересказала фактов. Он может не понять ваших эмоций.", "Ваше позитивное настроение - залог хорошего досуга. Не рассказывайте вашему другу о плохом настроении. Он может не понять ваших эмоций.", "Ваше позитивное настроение - залог хорошего досуга. Старайтесь не давить на него негативными эмоциями, и все будет хорошо!"},
                {"Он не любит массовые скопления людей и шум. Создайте лучше дома уютное гнездо.", "Если вам нравится, можете встречаться в тихой домашней обстановке, но иногда поссещайте с ним шумные меропрятия.", "Он очень активен. Постарайтесь поддержать это.", "Если ему наскучит ваш образ жизни - он может уйти. Не потакайте его капризам, покажите, как вы незаменимы.", "Он готов разделять ваши интересы, но вам сперва надо заинтересовать его.", "Он согласен даже на рай в шалаше. Только покажите, что цените его.", "Если будете терпеть его резкие перемены настроения, то сможете стать хорошими друзьями.", "Он будет рад встречаться с вами снова и снова, ведь вы дарите спокойствие и уверенность.", "Вы станете для него тихой гаванью, в которой он всегда может быть уверен.", "Он вполне готов сидеть дома с чашкой чая и смотреть с вами на звезды.", "Обустройте быт как вам нравится. Если где-то он начнет злиться - дайте ему вкусненького.", "Вам может быть страшновато. Вы представляете итальянскую семью со всеми жестами и эмоциями? Вот примерно так и будет.", "Вы с другом имеете много общего в стиле жизни - вы цените традиции, нормы, не стремитесь нарушать правила в угоду нелепым импульсам. Вы точно сможете организовать свой досуг и интересно провести время.", "Ваш друг гораздо активнее вас ищет новые хобби и впечатления. Не теряйте такой возможности, присоединяйтесь к нему, откройте для себя новый опыт, наслаждайтесь интересными событиями, которые никогда бы не попробовали сами.", "Вы цените традиции и стараетесь не нарушать правила у угоду нелепым импульсам, а ваш друг очень активно исследует свои возможности. Это может напрягать вас, ведь он стремится разрушить стабильный уклад жизни. Если вы сможете отказаться от своих принципов, то окунетесь в безну нового опыта и впечатлений."},
                {"Он не любит массовые скопления людей и шум. Создайте уют дома или выведите в поход, например.", "Зовите ео на любые тусовки и мероприятия. Но иногда возвращайте домой, в тишину. Вам обоим передышка пойдет на пользу.", "Он очень активен. При желании вдвоем и горы свернете.", "Он присоединится к вашим увлечениям, если ему самому это будет интересно. Покажите ему, что вы незаменимы, а не потакайте его капризам.", "Вы наверняка сможете заинтересовать его новым хобби, путешествием или мероприятием.", "И дома, и на шумной вечеринке, и в путешствии - он всегда будет с вами, только не забывайте говорить, как цените его", "Вам может стать скучно терпеть его постоянные перемены настроения. Но до тех пор ваша энергия может завести вас в самые неожиданные места.", "Вы станете для него хорошим спутником и в приключениях, и в быту. Вы дарите ощущение уверенности и спокойствия.", "Вы нравитесь ему за предсказуемость, но когда ваше любопытство будет брать вверх, могут возникать сложности с его консерватизмом.", "С ним будет удобно и в музей, и на вечеринку, и дома чаю попить.", "Иногда вам обоим не хватает толчка для старта. Проявите инициативу - будет друг.", "Как на вулкане жить. Вы представляете итальянскую семью со всеми жестами и эмоциями? Вот примерно так и будет.", "Вы сохраняете отличный баланс между следованием традициям общества и поиском интересных впечатлений, однако ваш друг более нацелен на правила и нормы. Вам может стать скучно с ним, если захотите развлечься. Для продуктивного общения вам стоит выбирать стандартную деятельность и избегать неоднозначных тем для разговора.", "Вы оба знаете, как можно развлечься, но также знаете, как это сделать,не теряя головы и не нарушая закон. Это хорошая тенденция. Скорее отправляйтесь в путь за новым опытом и впечатлениями!", "Вы сохраняете отличный баланс между следованием правилам и поиском острых ощущений. Ваш друг же в основном нацелен на впечатления, он очень любопытен. Вам может иногда казаться, что он чересчур беспечен и не приспособлен к реальной жизни. Ваше общение будет продуктивнее, если вы сосредоточитесь на интересном времяпрепровождении и будете уделять минимум времени быту."},
                {"Он не любит массовые скопления людей и шум. Ориентируйтесь на это, когда будете куда-то звать.", "Зовите его на любые тусовки и мероприятия. Но иногда возвращайте домой, в тишину.", "Вдвоем и горы свернете!", "Он присоединится к вашим приключениям, если ему самому это будет интересно.", "Он с радостью примкнет к вашим приключениям, а если не сможет - не беда, он может позаботиться о себе сам.", "Куда бы ни завело вас ваше любопытство, он обязательно примкнет к вам.", "Ваша неуемная энергия может занести вас в самые неожиданные места.", "Отличный друг, который поддержит вас в приключениях, но остановит от неприятностей.", "У вас могут возникать сложности, когда ваше любопытство напорется на его консерватизм.", "Он с радостью разделит ваше любопытство к новым местам и свершениям.", "Берите инициативу с свои руки. Иногда спрашивайте, все ли ему нравится.", "Это весело. Вы представляете итальянскую семью со всеми жестами и эмоциями? Вот примерно так и будет.", "Вы очень цените острые ощущения и новый опыт, а ваш друг, несмотря на то, что разделяет это, также следует правилам и традициям общества. Вас может раздражать такой подход, поскольку он всегда будет придерживаться их и останавливать вас.", "Вы очень любознательны и открыты новым впечатлениям, а ваш друг предпочитает следовать традициям и нормам общества. Вам есть, чему поучиться друг у друга. Ваше общение будет проходить интереснее, если вы посвятите его не критике стиля жизни партнера, а поймете, что в такой противоположности можно найти что-то интересное.", "Вы любознательны и открыты новому. Скорее берите вашего друга, и вдвоем наслаждайтесь новыми впечатлениями и интересными событиями!"}
            };

        private readonly string[,] _recommendationTexts = new string[,]
            {
                {"Амбивалентности встречаются, и им частенько интересно друг с другом, несмотря на то, что иногда Вы совершено по -разному смотрите на мир. Расскажите о результатах своим друзьям, пусть они тоже узнают, насколько похожи на Вас!","Вы дополняете друг друга. Вы можете спорить или соглашаться друг с другом, но каждый раз это что-то новое и интересное!"},
                {"Очень неплохо! Может быть, устроить вечеринку? Расскажите о результатах своим друзьям, может, они тоже присоединяться?","Так-так, вот и еще одна парочка наметилась ;) В театр, кабак или на дискотеку? Расскажите о результатах своим друзьям, может быть, они к Вам присоединятся?"},
                {"Встретить близкого по духу человека - настоящая удача! Не теряйте друг друга - и будет Вам счастье :) Расскажите о результатах своим друзьям!","Вы удивительно бликие по духу люди! Старайтесь держаться вместе! Расскажите о результатах своим друзьям!"},
                {"Вам говорили о том, что Вы близнецы? Если нет, то мы с удовольствием сообщаем Вам об этом :) Расскажите о результатах своим друзьям, они стоят того, чтобы гордиться!","Ваша дружба просто удивительна! Вы настолько похожи, что думаете одинаково! Расскажите о результатах своим друзьям, они стоят того, чтобы гордиться!"},
                {"Нет-нет! Такого не бывает! Вы точно разные люди? Расскажите о результатах своим друзьям, это действительно стоит того, чтобы рассказть всему миру!","Ну ничего себе! Ваши результаты просто поразительны! Расскажите о результатах своим друзьям, это действительно стоит того, чтобы рассказть всему миру!"}
            };

        public CongruenceOutcomeComputer(IRespondentsRepository respondentsRepository, ILogger log, IQuestionnaireRepository questionnaireRepository)
        {
            _respondentsRepository = respondentsRepository;
            _log = log;
            _questionnaireRepository = questionnaireRepository;
        }


        public PermanentCongruenceResults ComputeOutcome(string permaTokenA, string permaTokenB)
        {
            var retval = new PermanentCongruenceResults();
            try
            {
                var refer = _respondentsRepository.GetPermanentResults(permaTokenA);
                var victim = _respondentsRepository.GetPermanentResults(permaTokenB);

                if (refer?.ScopeId != victim?.ScopeId)
                    return retval;

                if (refer.ScopeId != 224053984)
                {
                    _log.Warning("Only 224053984 test is supported now.");
                    return retval;
                }
                retval.ScopeId = refer.ScopeId;
                var quest = _questionnaireRepository.FindQuestionnaireById(refer.ScopeId);

                var mapR = MapResultsForQuestFifth(refer, quest);
                var mapV = MapResultsForQuestFifth(victim, quest);
                var matches = new List<(int indexR, int indexV, string nameR, string nameV, double val, bool match)>();

                for (int i = 0; i < mapR.Length; i++)
                    for (int j = 0; j < mapV.Length; j++)
                        matches.Add((i, j, mapR[i].Name, mapV[j].Name, _adjuscentMatrix[i, j], _adjuscentMatrix[i, j] == 0.8 && mapR[i].Value == 1 && mapV[j].Value == 1));

                var rnd = new Random();

                var perUno = from a in matches
                             group a by a.nameV into g
                             let x = g.FirstOrDefault()
                             select new CongruenceOutcome
                             {
                                 ScaleName = g.Key,
                                 ScaleWeight = g.Count(z => z.match) / 5.0 * 100.0,
                                 ScaleDescription = _adjuscentTextes[x.indexR, x.indexV]
                             };
                retval.CongruenceOutcomes = perUno.ToArray();
                retval.MagicCoefficient = matches.Count(z => z.match) / 25.0 * 100.0;
                var p = Perc(matches.Count(z => z.match));
                retval.RecommendationRate = p.val;
                retval.RecommendationText = _recommendationTexts[p.index, rnd.Next(0, 2)];
                var reg_name = new Regex("first_name.*?\":\"(?<first_name>.*?)\"", RegexOptions.Compiled);
                var reg_lname = new Regex("last_name.*?\":\"(?<last_name>.*?)\"", RegexOptions.Compiled);
                var reg_profile = new Regex("photo_50.*?\":\"(?<reg_profile>.*?)\"", RegexOptions.Compiled);
                var first = _respondentsRepository.GetUserByToken(permaTokenA);
                var second = _respondentsRepository.GetUserByToken(permaTokenB);
                retval.UserIds = new int[] { first.VkId, second.VkId };
                retval.UserNames = new string[]
                {
                    $"{reg_name.Match(first.DataVkontakte?.UsersGet).Groups["first_name"].Value} {reg_lname.Match(first.DataVkontakte?.UsersGet).Groups["last_name"].Value}",
                    $"{reg_name.Match(second.DataVkontakte?.UsersGet).Groups["first_name"].Value} {reg_lname.Match(second.DataVkontakte?.UsersGet).Groups["last_name"].Value}"
                };
                retval.UserAvatarts= new string[]
                {
                    $"{reg_profile.Match(first.DataVkontakte?.UsersGet).Groups["reg_profile"].Value}",
                    $"{reg_profile.Match(second.DataVkontakte?.UsersGet).Groups["reg_profile"].Value}"
                };
                _log.Information($"Congruence computed {retval}");
            }
            catch (Exception ex)
            {
                _log.Error(ex, ex.Message);
            }
            return retval;
        }

        private (int index, double val) Perc(double count)
        {
            var tmp = count / 25.0 * 100.0;
            if (tmp < 50)
                return (0, 50);
            if (tmp >= 50 && tmp <= 65)
                return (1, tmp + 10);
            if (tmp > 65 && tmp <= 90)
                return (2, tmp + 5);
            return (3, tmp);
        }

        private (string Name, int Index, double Value)[] MapResultsForQuestFifth(PermanentResults answers, QuestionnaireScope quest)
        {
            var outcomes = answers.Outcomes;
            var vector = new(string Name, int Index, double Value)[quest.Outcomes.Max(z => z.Index)];
            foreach (var o in quest.Outcomes)
                vector[o.Index - 1] = (o.CaptionText, o.Index, outcomes.Any(z => z.Index == o.Index) ? 1 : 0);
            
            return vector;
        }
    }
}
